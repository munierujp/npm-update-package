
import app from '../../../../package.json'
import type { OutdatedPackage } from '../../../core'
import { readFile } from '../../../file'
import { toJSON } from '../../../json'
import {
  extractRepository,
  parsePackageJson
} from '../../../package-json'
import { createPullRequestMetadata } from '../metadata'

export const createPullRequestBody = async (outdatedPackage: OutdatedPackage): Promise<string> => {
  const packageJson = await readFile(`node_modules/${outdatedPackage.name}/package.json`)
  const pkg = parsePackageJson(packageJson)
  const gitRepo = extractRepository(pkg)
  const repositoryLink = gitRepo !== undefined ? `[${gitRepo.owner}/${gitRepo.name}](${gitRepo.url.toString()})` : undefined
  const currentVersion = outdatedPackage.currentVersion.version
  const newVersion = outdatedPackage.newVersion.version
  const packageName = outdatedPackage.name
  const level = outdatedPackage.level
  const packageLink = `[${packageName}](https://www.npmjs.com/package/${packageName})`
  const metadata = toJSON(createPullRequestMetadata([outdatedPackage]), { pretty: true })
  return `This PR updates these packages:

|Package|Repository|Level|Current version|New version|
|---|---|---|---|---|
|${packageLink}|${repositoryLink ?? '-'}|${level}|\`${currentVersion}\`|\`${newVersion}\`|

<details>
<summary>Metadata</summary>

**Don't remove or edit this section because it will be used by npm-update-package.**

<div id="npm-update-package-metadata">

\`\`\`json
${metadata}
\`\`\`

</div>
</details>

---
This PR has been generated by [${app.name}](${app.homepage}) v${app.version}`
}
